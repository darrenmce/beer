#!/usr/bin/env node

var osmosis = require('osmosis');
var colors = require('colors');
var program = require('commander');

program
  .version('0.0.1')
  .parse(process.argv);

var beer = 'BeerName=' + encodeURIComponent(program.args.join(' '));

osmosis
.post('http://www.ratebeer.com/findbeer.asp', beer,
  {
    'Content-Type': 'application/x-www-form-urlencoded'
  })
  .find('table.table.table-hover.table-striped:first tr > td:first > a')
  .set('beer')
  .follow('@href')
  .find('span[itemprop="rating"]')
  .set('overall', 'div > div > span:nth-child(3)')
  .find('span[itemprop="average"]')
  .set('style')
  .data(function(data) {
    console.log(formatData(data));
  });


function formatRating(rating) {
  rating = Number(rating);
  if (isNaN(rating)) {
    rating = -5;
  }
  if (rating < 0) {
    return colors.cyan('unknown :(');
  }
  if (rating < 10) {
    return colors.red('toilet water from a dirty toilet');
  }
  if (rating < 20) {
    return colors.red('basically toilet water');
  }
  if (rating < 30) {
    return colors.red('utter shit');
  }
  if (rating < 40) {
    return colors.magenta('pretty shit');
  }
  if (rating < 50) {
    return colors.magenta('rather shit');
  }
  if (rating < 60) {
    return colors.magenta('borderline bad');
  }
  if (rating < 70) {
    return colors.yellow('not so great');
  }
  if (rating < 80) {
    return colors.yellow('not bad');
  }
  if (rating < 85) {
    return colors.yellow('pretty good');
  }
  if (rating < 90) {
    return colors.green('a great beer, it really is');
  }
  if (rating < 95) {
    return colors.green('... jackanackanorry! that\'s good');
  }
  return colors.green('better than bond.');
}


function formatData(data) {
  return 'The beer ' +
    colors.blue(data.beer) +
    'is ' +
    formatRating(data.overall) +
    '. (' +
    data.overall +
    ' | ' +
    data.style +
    ')';
}